var __reflect=this&&this.__reflect||function(e,n,t){e.__class__=n,t?t.push(n):t=[n],e.__types__=e.__types__?t.concat(e.__types__):t},__extends=this&&this.__extends||function(e,n){function t(){this.constructor=e}for(var i in n)n.hasOwnProperty(i)&&(e[i]=n[i]);t.prototype=n.prototype,e.prototype=new t},KBEngine;!function(KBEngine){function INFO_MSG(e){console.info(e)}function DEBUG_MSG(e){console.debug(e)}function ERROR_MSG(e){console.error(e)}function WARNING_MSG(e){console.warn(e)}function utf8ArrayToString(e){var n,t,i,r,a,p;for(n="",i=e.length,t=0;i>t;)switch(r=e[t++],r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n+=String.fromCharCode(r);break;case 12:case 13:a=e[t++],n+=String.fromCharCode((31&r)<<6|63&a);break;case 14:a=e[t++],p=e[t++],n+=String.fromCharCode((15&r)<<12|(63&a)<<6|(63&p)<<0)}return n}function stringToUTF8Bytes(e){for(var n=[],t=0;t<e.length;t++){var i=e.charCodeAt(t);128>i?n.push(i):2048>i?n.push(192|i>>6,128|63&i):55296>i||i>=57344?n.push(224|i>>12,128|i>>6&63,128|63&i):(t++,i=65536+((1023&i)<<10|1023&e.charCodeAt(t)),n.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return n}function mappingDataType(){KBEngine.datatype2id={},KBEngine.datatype2id.STRING=1,KBEngine.datatype2id["STD::STRING"]=1,KBEngine.datatype2id.UINT8=2,KBEngine.datatype2id.BOOL=2,KBEngine.datatype2id.DATATYPE=2,KBEngine.datatype2id.CHAR=2,KBEngine.datatype2id.DETAIL_TYPE=2,KBEngine.datatype2id.ENTITYCALL_CALL_TYPE=2,KBEngine.datatype2id.UINT16=3,KBEngine.datatype2id["UNSIGNED SHORT"]=3,KBEngine.datatype2id.SERVER_ERROR_CODE=3,KBEngine.datatype2id.ENTITY_TYPE=3,KBEngine.datatype2id.ENTITY_PROPERTY_UID=3,KBEngine.datatype2id.ENTITY_METHOD_UID=3,KBEngine.datatype2id.ENTITY_SCRIPT_UID=3,KBEngine.datatype2id.DATATYPE_UID=3,KBEngine.datatype2id.UINT32=4,KBEngine.datatype2id.UINT=4,KBEngine.datatype2id["UNSIGNED INT"]=4,KBEngine.datatype2id.ARRAYSIZE=4,KBEngine.datatype2id.SPACE_ID=4,KBEngine.datatype2id.GAME_TIME=4,KBEngine.datatype2id.TIMER_ID=4,KBEngine.datatype2id.UINT64=5,KBEngine.datatype2id.DBID=5,KBEngine.datatype2id.COMPONENT_ID=5,KBEngine.datatype2id.INT8=6,KBEngine.datatype2id.COMPONENT_ORDER=6,KBEngine.datatype2id.INT16=7,KBEngine.datatype2id.SHORT=7,KBEngine.datatype2id.INT32=8,KBEngine.datatype2id.INT=8,KBEngine.datatype2id.ENTITY_ID=8,KBEngine.datatype2id.CALLBACK_ID=8,KBEngine.datatype2id.COMPONENT_TYPE=8,KBEngine.datatype2id.INT64=9,KBEngine.datatype2id.PYTHON=10,KBEngine.datatype2id.PY_DICT=10,KBEngine.datatype2id.PY_TUPLE=10,KBEngine.datatype2id.PY_LIST=10,KBEngine.datatype2id.ENTITYCALL=10,KBEngine.datatype2id.BLOB=11,KBEngine.datatype2id.UNICODE=12,KBEngine.datatype2id.FLOAT=13,KBEngine.datatype2id.DOUBLE=14,KBEngine.datatype2id.VECTOR2=15,KBEngine.datatype2id.VECTOR3=16,KBEngine.datatype2id.VECTOR4=17,KBEngine.datatype2id.FIXED_DICT=18,KBEngine.datatype2id.ARRAY=19}function bindWriter(e,n){switch(n){case KBEngine.datatype2id.UINT8:return e.writeUint8;case KBEngine.datatype2id.UINT16:return e.writeUint16;case KBEngine.datatype2id.UINT32:return e.writeUint32;case KBEngine.datatype2id.UINT64:return e.writeUint64;case KBEngine.datatype2id.INT8:return e.writeInt8;case KBEngine.datatype2id.INT16:return e.writeInt16;case KBEngine.datatype2id.INT32:return e.writeInt32;case KBEngine.datatype2id.INT64:return e.writeInt64;case KBEngine.datatype2id.FLOAT:return e.writeFloat;case KBEngine.datatype2id.DOUBLE:return e.writeDouble;case KBEngine.datatype2id.STRING:return e.writeString;case KBEngine.datatype2id.FIXED_DICT:return e.writeStream;case KBEngine.datatype2id.ARRAY:return e.writeStream;default:return e.writeStream}}function bindReader(e){switch(e){case KBEngine.datatype2id.UINT8:return KBEngine.reader.readUint8;case KBEngine.datatype2id.UINT16:return KBEngine.reader.readUint16;case KBEngine.datatype2id.UINT32:return KBEngine.reader.readUint32;case KBEngine.datatype2id.UINT64:return KBEngine.reader.readUint64;case KBEngine.datatype2id.INT8:return KBEngine.reader.readInt8;case KBEngine.datatype2id.INT16:return KBEngine.reader.readInt16;case KBEngine.datatype2id.INT32:return KBEngine.reader.readInt32;case KBEngine.datatype2id.INT64:return KBEngine.reader.readInt64;case KBEngine.datatype2id.FLOAT:return KBEngine.reader.readFloat;case KBEngine.datatype2id.DOUBLE:return KBEngine.reader.readDouble;case KBEngine.datatype2id.STRING:return KBEngine.reader.readString;case KBEngine.datatype2id.FIXED_DICT:return KBEngine.reader.readStream;case KBEngine.datatype2id.ARRAY:return KBEngine.reader.readStream;default:return KBEngine.reader.readStream}}function clampf(e,n,t){if(n>t){var i=n;n=t,t=i}return n>e?n:t>e?e:t}function int82angle(e,n){return e*(Math.PI/(n?254:128))}function angle2int8(e,n){var t=0;return t=n?clampf(Math.floor(254*e/Math.PI+.5),-128,127):Math.floor(128*e/Math.PI+.5)}function create(e){if(void 0==KBEngine.app){if(e.constructor!=KBEngineArgs)return void ERROR_MSG("create(): args("+e+") error! not is KBEngineArgs");new KBEngineApp(e),KBEngine.app.reset(),KBEngine.app.installEvents(),idInterval=setInterval(KBEngine.app.update,e.updateHZ)}}function destroy(){void 0!=idInterval&&clearInterval(idInterval),void 0!=KBEngine.app&&(KBEngine.app.uninstallEvents(),KBEngine.app.reset(),KBEngine.app=void 0)}var Class=function(){function e(){}return e}();KBEngine.Class=Class,__reflect(Class.prototype,"KBEngine.Class"),KBEngine.PACKET_MAX_SIZE=1500,KBEngine.PACKET_MAX_SIZE_TCP=1460,KBEngine.PACKET_MAX_SIZE_UDP=1472,KBEngine.MESSAGE_ID_LENGTH=2,KBEngine.MESSAGE_LENGTH_LENGTH=2,KBEngine.CLIENT_NO_FLOAT=0,KBEngine.KBE_FLT_MAX=3.402823466e38;var INT64=function(){function e(e,n){this.sign=1,this.lo=e,this.hi=n,n>=2147483648&&(this.sign=-1,this.lo>0?(this.lo=4294967296-this.lo&4294967295,this.hi=4294967295-this.hi):(this.lo=4294967296-this.lo&4294967295,this.hi=4294967296-this.hi))}return e.prototype.toString=function(){var e="";this.sign<0&&(e+="-");var n=this.lo.toString(16),t=this.hi.toString(16);if(this.hi>0){e+=t;for(var i=8-n.length;i>0;--i)e+="0"}return e+=n},e}();KBEngine.INT64=INT64,__reflect(INT64.prototype,"KBEngine.INT64");var UINT64=function(){function e(e,n){this.lo=e,this.hi=n}return e.prototype.toString=function(){var e=this.lo.toString(16),n=this.hi.toString(16),t="";if(this.hi>0){t+=n;for(var i=8-e.length;i>0;--i)t+="0"}return t+=e},e}();KBEngine.UINT64=UINT64,__reflect(UINT64.prototype,"KBEngine.UINT64"),KBEngine.INFO_MSG=INFO_MSG,KBEngine.DEBUG_MSG=DEBUG_MSG,KBEngine.ERROR_MSG=ERROR_MSG,KBEngine.WARNING_MSG=WARNING_MSG,KBEngine.utf8ArrayToString=utf8ArrayToString,KBEngine.stringToUTF8Bytes=stringToUTF8Bytes;var EventInfo=function(){function e(e,n){this.callbackfn=n,this.classinst=e}return e}();KBEngine.EventInfo=EventInfo,__reflect(EventInfo.prototype,"KBEngine.EventInfo");var Events=function(){function Events(){this._events={}}return Events.prototype.register=function(evtName,classinst,strCallback){var callbackfn=eval("classinst."+strCallback);if(void 0==callbackfn)return void ERROR_MSG("export class Event::fire: not found strCallback("+classinst+")!"+strCallback);var evtlst=this._events[evtName];void 0==evtlst&&(evtlst=[],this._events[evtName]=evtlst);var info=new EventInfo(classinst,callbackfn);evtlst.push(info)},Events.prototype.deregister=function(e,n){for(var t in this._events)for(var i=this._events[t];;){for(var r=!1,a=0;a<i.length;a++){var p=i[a];if(p.classinst==n){i.splice(a,1),r=!0;break}}if(!r)break}},Events.prototype.fire=function(e){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];if(arguments.length<1)return void ERROR_MSG("export class Event::fire: not found eventName!");var i=this._events[e];if(void 0!=i){for(var r=[],a=1;a<n.length;a++)r.push(n[a]);for(var a=0;a<i.length;a++){var p=i[a];r.length<1?p.callbackfn.apply(p.classinst):p.callbackfn.apply(p.classinst,r)}}},Events}();KBEngine.Events=Events,__reflect(Events.prototype,"KBEngine.Events"),KBEngine.Event=new Events;var MemoryStream=function(){function e(e){this.rpos=0,this.wpos=0,e instanceof ArrayBuffer?this.buffer=e:this.buffer=new ArrayBuffer(e),this.rpos=0,this.wpos=0}return e.prototype.readInt8=function(){var e=new Int8Array(this.buffer,this.rpos,1);return this.rpos+=1,e[0]},e.prototype.readInt16=function(){var e=this.readUint16();return e>=32768&&(e-=65536),e},e.prototype.readInt32=function(){var e=this.readUint32();return e>=2147483648&&(e-=4294967296),e},e.prototype.readInt64=function(){return new INT64(this.readUint32(),this.readUint32())},e.prototype.readUint8=function(){var e=new Uint8Array(this.buffer,this.rpos,1);return this.rpos+=1,e[0]},e.prototype.readUint16=function(){var e=new Uint8Array(this.buffer,this.rpos);return this.rpos+=2,((255&e[1])<<8)+(255&e[0])},e.prototype.readUint32=function(){var e=new Uint8Array(this.buffer,this.rpos);return this.rpos+=4,(e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0]},e.prototype.readUint64=function(){return new UINT64(this.readUint32(),this.readUint32())},e.prototype.readFloat=function(){var e;try{e=new Float32Array(this.buffer,this.rpos,1)}catch(n){e=new Float32Array(this.buffer.slice(this.rpos,this.rpos+4))}return this.rpos+=4,e[0]},e.prototype.readDouble=function(){var e;try{e=new Float64Array(this.buffer,this.rpos,1)}catch(n){e=new Float64Array(this.buffer.slice(this.rpos,this.rpos+8),0,1)}return this.rpos+=8,e[0]},e.prototype.readString=function(){for(var e=new Uint8Array(this.buffer,this.rpos),n=0,t="";;){if(0==e[n]){n++;break}if(t+=String.fromCharCode(e[n]),n++,this.rpos+n>=this.buffer.byteLength)throw new Error("export class MemoryStream::readString: rpos("+(this.rpos+n)+")>="+this.buffer.byteLength+" overflow!")}return this.rpos+=n,t},e.prototype.readBlob=function(){var e=this.readUint32(),n=new Uint8Array(this.buffer,this.rpos,e);return this.rpos+=e,n},e.prototype.readStream=function(){var n=new Uint8Array(this.buffer,this.rpos,this.buffer.byteLength-this.rpos);return this.rpos=this.buffer.byteLength,new e(n)},e.prototype.readPackXZ=function(){var n=new e.PackFloatXType,t=new e.PackFloatXType;n.fv[0]=0,t.fv[0]=0,n.uv[0]=1073741824,t.uv[0]=1073741824;var i=this.readUint8(),r=this.readUint8(),a=this.readUint8(),p=0;p|=i<<16,p|=r<<8,p|=a,n.uv[0]|=(8384512&p)<<3,t.uv[0]|=(2047&p)<<15,n.fv[0]-=2,t.fv[0]-=2,n.uv[0]|=(8388608&p)<<8,t.uv[0]|=(2048&p)<<20;var o=new Array(2);return o[0]=n.fv[0],o[1]=t.fv[0],o},e.prototype.readPackY=function(){var e=this.readUint16();return e},e.prototype.writeInt8=function(e){var n=new Int8Array(this.buffer,this.wpos,1);n[0]=e,this.wpos+=1},e.prototype.writeInt16=function(e){this.writeInt8(255&e),this.writeInt8(e>>8&255)},e.prototype.writeInt32=function(e){for(var n=0;4>n;n++)this.writeInt8(e>>8*n&255)},e.prototype.writeInt64=function(e){this.writeInt32(e.lo),this.writeInt32(e.hi)},e.prototype.writeUint8=function(e){var n=new Uint8Array(this.buffer,this.wpos,1);n[0]=e,this.wpos+=1},e.prototype.writeUint16=function(e){this.writeUint8(255&e),this.writeUint8(e>>8&255)},e.prototype.writeUint32=function(e){for(var n=0;4>n;n++)this.writeUint8(e>>8*n&255)},e.prototype.writeUint64=function(e){this.writeUint32(e.lo),this.writeUint32(e.hi)},e.prototype.writeFloat=function(e){try{var n=new Float32Array(this.buffer,this.wpos,1);n[0]=e}catch(t){var n=new Float32Array(1);n[0]=e;var i=new Uint8Array(this.buffer),r=new Uint8Array(n.buffer);i.set(r,this.wpos)}this.wpos+=4},e.prototype.writeDouble=function(e){try{var n=new Float64Array(this.buffer,this.wpos,1);n[0]=e}catch(t){var n=new Float64Array(1);n[0]=e;var i=new Uint8Array(this.buffer),r=new Uint8Array(n.buffer);i.set(r,this.wpos)}this.wpos+=8},e.prototype.writeBlob=function(e){var n=e.length;if(n+4>this.space())return void ERROR_MSG("memorystream::writeBlob: no free!");this.writeUint32(n);var t=new Uint8Array(this.buffer,this.wpos,n);if("string"==typeof e)for(var i=0;n>i;i++)t[i]=e.charCodeAt(i);else for(var i=0;n>i;i++)t[i]=e[i];this.wpos+=n},e.prototype.writeString=function(e){if(e.length>this.space())return void ERROR_MSG("memorystream::writeString: no free!");for(var n=new Uint8Array(this.buffer,this.wpos),t=0,i=0;i<e.length;i++)n[t++]=e.charCodeAt(i);n[t++]=0,this.wpos+=t},e.prototype.readSkip=function(e){this.rpos+=e},e.prototype.space=function(){return this.buffer.byteLength-this.wpos},e.prototype.length=function(){return this.wpos-this.rpos},e.prototype.readEOF=function(){return this.buffer.byteLength-this.rpos<=0},e.prototype.done=function(){this.rpos=this.wpos},e.prototype.getbuffer=function(e){return this.buffer.slice(this.rpos,this.wpos)},e}();KBEngine.MemoryStream=MemoryStream,__reflect(MemoryStream.prototype,"KBEngine.MemoryStream"),function(e){var n=function(){function e(){this._unionData=new ArrayBuffer(4),this.fv=new Float32Array(this._unionData,0,1),this.uv=new Uint32Array(this._unionData,0,1),this.iv=new Int32Array(this._unionData,0,1)}return e}();e.PackFloatXType=n,__reflect(n.prototype,"KBEngine.MemoryStream.PackFloatXType")}(MemoryStream=KBEngine.MemoryStream||(KBEngine.MemoryStream={}));var Bundle=function(){function e(){this.memorystreams=new Array,this.numMessage=0,this.messageLengthBuffer=null,this.msgtype=null,this.messageLength=0,this.stream=new MemoryStream(KBEngine.PACKET_MAX_SIZE_TCP)}return e.prototype.newMessage=function(e){this.fini(!1),this.msgtype=e,this.numMessage+=1,-1==this.msgtype.length&&(this.messageLengthBuffer=new Uint8Array(this.stream.buffer,this.stream.wpos+KBEngine.MESSAGE_ID_LENGTH,2)),this.writeUint16(e.id),this.messageLengthBuffer&&(this.writeUint16(0),this.messageLengthBuffer[0]=0,this.messageLengthBuffer[1]=0,this.messageLength=0)},e.prototype.writeMsgLength=function(e){this.messageLengthBuffer&&(this.messageLengthBuffer[0]=255&e,this.messageLengthBuffer[1]=e>>8&255)},e.prototype.fini=function(e){this.numMessage>0&&(this.writeMsgLength(this.messageLength),this.stream&&this.memorystreams.push(this.stream)),e&&(this.messageLengthBuffer=null,this.numMessage=0,this.msgtype=null)},e.prototype.send=function(e){this.fini(!0);for(var n=0;n<this.memorystreams.length;n++){var t=this.memorystreams[n];e.send(t.getbuffer())}this.memorystreams=new Array,this.stream=new MemoryStream(KBEngine.PACKET_MAX_SIZE_TCP)},e.prototype.checkStream=function(e){e>this.stream.space()&&(this.memorystreams.push(this.stream),this.stream=new MemoryStream(KBEngine.PACKET_MAX_SIZE_TCP)),this.messageLength+=e},e.prototype.writeInt8=function(e){this.checkStream(1),this.stream.writeInt8(e)},e.prototype.writeInt16=function(e){this.checkStream(2),this.stream.writeInt16(e)},e.prototype.writeInt32=function(e){this.checkStream(4),this.stream.writeInt32(e)},e.prototype.writeInt64=function(e){this.checkStream(8),this.stream.writeInt64(e)},e.prototype.writeUint8=function(e){this.checkStream(1),this.stream.writeUint8(e)},e.prototype.writeUint16=function(e){this.checkStream(2),this.stream.writeUint16(e)},e.prototype.writeUint32=function(e){this.checkStream(4),this.stream.writeUint32(e)},e.prototype.writeUint64=function(e){this.checkStream(8),this.stream.writeUint64(e)},e.prototype.writeFloat=function(e){this.checkStream(4),this.stream.writeFloat(e)},e.prototype.writeDouble=function(e){this.checkStream(8),this.stream.writeDouble(e)},e.prototype.writeString=function(e){this.checkStream(e.length+1),this.stream.writeString(e)},e.prototype.writeBlob=function(e){this.checkStream(e.length+4),this.stream.writeBlob(e)},e}();KBEngine.Bundle=Bundle,__reflect(Bundle.prototype,"KBEngine.Bundle"),KBEngine.reader=new MemoryStream(0),KBEngine.datatype2id={},KBEngine.mappingDataType=mappingDataType,mappingDataType(),KBEngine.bindWriter=bindWriter,KBEngine.bindReader=bindReader;var Message=function(){function e(e,n,t,i,r,a){this.id=e,this.name=n,this.length=t,this.argsType=i;for(var p=0;p<r.length;p++)r[p]=bindReader(r[p]);this.args=r,this.handler=a}return e.prototype.createFromStream=function(e){if(this.args.length<=0)return e;for(var n=new Array(this.args.length),t=0;t<this.args.length;t++)n[t]=this.args[t].call(e);return n},e.prototype.handleMessage=function(e){return null==this.handler?void ERROR_MSG("Message::handleMessage: interface("+this.name+"/"+this.id+") no implement!"):void(this.args.length<=0?this.argsType<0?this.handler(e):this.handler():this.handler.apply(KBEngine.app,this.createFromStream(e)))},e}();KBEngine.Message=Message,__reflect(Message.prototype,"KBEngine.Message");var messages;!function(e){e.loginapp={},e.baseapp={},e.Loginapp_importClientMessages=new Message(5,"importClientMessages",0,0,new Array,null),e.Baseapp_importClientMessages=new Message(207,"importClientMessages",0,0,new Array,null),e.Baseapp_importClientEntityDef=new Message(208,"importClientEntityDef",0,0,new Array,null),e.onImportClientMessages=new Message(518,"onImportClientMessages",-1,-1,new Array,null)}(messages=KBEngine.messages||(KBEngine.messages={})),KBEngine.clientmessages={},KBEngine.bufferedCreateEntityMessage={};var Vector3=function(e){function n(n,t,i){var r=e.call(this)||this;return r.x=n,r.y=t,r.z=i,r}return __extends(n,e),n.prototype.distance=function(e){var n=e.x-this.x,t=e.y-this.y,i=e.z-this.z;return Math.sqrt(n*n+t*t+i*i)},n}(Class);KBEngine.Vector3=Vector3,__reflect(Vector3.prototype,"KBEngine.Vector3"),KBEngine.clampf=clampf,KBEngine.int82angle=int82angle,KBEngine.angle2int8=angle2int8;var Entity=function(e){function n(){var n=e.call(this)||this;return n.id=0,n.className="",n.position=new Vector3(0,0,0),n.direction=new Vector3(0,0,0),n.velocity=0,n.cell=null,n.base=null,n.inWorld=!1,n.inited=!1,n.isControlled=!1,n.entityLastLocalPos=new Vector3(0,0,0),n.entityLastLocalDir=new Vector3(0,0,0),n.isOnGround=!1,n}return __extends(n,e),n.prototype.__init__=function(){},n.prototype.callPropertysSetMethods=function(){var e=KBEngine.moduledefs[this.className];for(var n in e.propertys){var t=e.propertys[n];t[0];n=t[2];var i=t[5],r=t[6],a=this[n];if(null!=i)if(32==r||64==r)this.inited&&!this.inWorld&&i.call(this,a);else if(this.inWorld){if((8==r||16==r)&&!this.isPlayer())continue;i.call(this,a)}}},n.prototype.onDestroy=function(){},n.prototype.onControlled=function(e){},n.prototype.isPlayer=function(){return this.id==KBEngine.app.entity_id},n.prototype.baseCall=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(e.length<1)return void ERROR_MSG("Entity::baseCall: not fount interfaceName!");if(void 0==this.base)return void ERROR_MSG("Entity::baseCall: base is None!");var t=KBEngine.moduledefs[this.className].base_methods[e[0]];if(void 0==t)return void ERROR_MSG("Entity::baseCall: The server did not find the def_method("+this.className+"."+e[0]+")!");var i=t[0],r=t[3];if(r.length-1!=r.length)return void ERROR_MSG("Entity::baseCall: args("+(r.length-1)+"!= "+r.length+") size is error!");this.base.newCall(),this.base.bundle.writeUint16(i);try{for(var a=0;a<r.length;a++){if(!r[a].isSameType(r[a+1]))throw new Error("Entity::baseCall: arg["+a+"] is error!");r[a].addToStream(this.base.bundle,r[a+1])}}catch(p){return ERROR_MSG(p.toString()),ERROR_MSG("Entity::baseCall: args is error!"),void(this.base.bundle=null)}this.base.sendCall()},n.prototype.cellCall=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(e.length<1)return void ERROR_MSG("Entity::cellCall: not fount interfaceName!");if(void 0==this.cell)return void ERROR_MSG("Entity::cellCall: cell is None!");var t=KBEngine.moduledefs[this.className].cell_methods[e[0]];if(void 0==t)return void ERROR_MSG("Entity::cellCall: The server did not find the def_method("+this.className+"."+e[0]+")!");var i=t[0],r=t[3];if(r.length-1!=r.length)return void ERROR_MSG("Entity::cellCall: args("+(r.length-1)+"!= "+r.length+") size is error!");this.cell.newCall(),this.cell.bundle.writeUint16(i);try{for(var a=0;a<r.length;a++){if(!r[a].isSameType(r[a+1]))throw new Error("Entity::cellCall: arg["+a+"] is error!");r[a].addToStream(this.cell.bundle,r[a+1])}}catch(p){return ERROR_MSG(p.toString()),ERROR_MSG("Entity::cellCall: args is error!"),void(this.cell.bundle=null)}this.cell.sendCall()},n.prototype.enterWorld=function(){INFO_MSG(this.className+"::enterWorld: "+this.id),this.inWorld=!0,this.onEnterWorld(),KBEngine.Event.fire("onEnterWorld",this)},n.prototype.onEnterWorld=function(){},n.prototype.leaveWorld=function(){INFO_MSG(this.className+"::leaveWorld: "+this.id),this.inWorld=!1,this.onLeaveWorld(),KBEngine.Event.fire("onLeaveWorld",this)},n.prototype.onLeaveWorld=function(){},n.prototype.enterSpace=function(){INFO_MSG(this.className+"::enterSpace: "+this.id),this.onEnterSpace(),KBEngine.Event.fire("onEnterSpace",this),KBEngine.Event.fire("set_position",this),KBEngine.Event.fire("set_direction",this)},n.prototype.onEnterSpace=function(){},n.prototype.leaveSpace=function(){INFO_MSG(this.className+"::leaveSpace: "+this.id),this.onLeaveSpace(),KBEngine.Event.fire("onLeaveSpace",this)},n.prototype.onLeaveSpace=function(){},n.prototype.set_position=function(){this.isPlayer()&&(KBEngine.app.entityServerPos.x=this.position.x,KBEngine.app.entityServerPos.y=this.position.y,KBEngine.app.entityServerPos.z=this.position.z),KBEngine.Event.fire("set_position",this)},n.prototype.onUpdateVolatileData=function(){},n.prototype.set_direction=function(e){KBEngine.Event.fire("set_direction",this)},n}(Class);KBEngine.Entity=Entity,__reflect(Entity.prototype,"KBEngine.Entity"),KBEngine.ENTITYCALL_TYPE_CELL=0,KBEngine.ENTITYCALL_TYPE_BASE=1;var EntityCall=function(){function e(){this.id=0,this.className="",this.type=KBEngine.ENTITYCALL_TYPE_CELL,this.networkInterface=KBEngine.app,this.bundle=null}return e.prototype.isBase=function(){return this.type==KBEngine.ENTITYCALL_TYPE_BASE},e.prototype.isCell=function(){return this.type==KBEngine.ENTITYCALL_TYPE_CELL},e.prototype.newCall=function(){return null==this.bundle&&(this.bundle=new Bundle),this.type==KBEngine.ENTITYCALL_TYPE_CELL?this.bundle.newMessage(messages.Baseapp_onRemoteCallCellMethodFromClient):this.bundle.newMessage(messages.Entity_onRemoteMethodCall),this.bundle.writeInt32(this.id),this.bundle},e.prototype.sendCall=function(e){void 0==e&&(e=this.bundle),e.send(this.networkInterface),this.bundle==e&&(this.bundle=null)},e}();KBEngine.EntityCall=EntityCall,__reflect(EntityCall.prototype,"KBEngine.EntityCall"),KBEngine.moduledefs={};var DATATYPE_UINT8=function(){function DATATYPE_UINT8(){}return DATATYPE_UINT8.prototype.bind=function(){},DATATYPE_UINT8.prototype.createFromStream=function(e){return KBEngine.reader.readUint8.call(e)},DATATYPE_UINT8.prototype.addToStream=function(e,n){e.writeUint8(n)},DATATYPE_UINT8.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_UINT8.prototype.isSameType=function(e){return"number"!=typeof e?!1:0>e||e>255?!1:!0},DATATYPE_UINT8}();KBEngine.DATATYPE_UINT8=DATATYPE_UINT8,__reflect(DATATYPE_UINT8.prototype,"KBEngine.DATATYPE_UINT8");var DATATYPE_UINT16=function(){function DATATYPE_UINT16(){}return DATATYPE_UINT16.prototype.bind=function(){},DATATYPE_UINT16.prototype.createFromStream=function(e){return KBEngine.reader.readUint16.call(e)},DATATYPE_UINT16.prototype.addToStream=function(e,n){e.writeUint16(n)},DATATYPE_UINT16.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_UINT16.prototype.isSameType=function(e){return"number"!=typeof e?!1:0>e||e>65535?!1:!0},DATATYPE_UINT16}();KBEngine.DATATYPE_UINT16=DATATYPE_UINT16,__reflect(DATATYPE_UINT16.prototype,"KBEngine.DATATYPE_UINT16");var DATATYPE_UINT32=function(){function DATATYPE_UINT32(){}return DATATYPE_UINT32.prototype.bind=function(){},DATATYPE_UINT32.prototype.createFromStream=function(e){return KBEngine.reader.readUint32.call(e)},DATATYPE_UINT32.prototype.addToStream=function(e,n){e.writeUint32(n)},DATATYPE_UINT32.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_UINT32.prototype.isSameType=function(e){return"number"!=typeof e?!1:0>e||e>4294967295?!1:!0},DATATYPE_UINT32}();KBEngine.DATATYPE_UINT32=DATATYPE_UINT32,__reflect(DATATYPE_UINT32.prototype,"KBEngine.DATATYPE_UINT32");var DATATYPE_UINT64=function(){function DATATYPE_UINT64(){}return DATATYPE_UINT64.prototype.bind=function(){},DATATYPE_UINT64.prototype.createFromStream=function(e){return KBEngine.reader.readUint64.call(e)},DATATYPE_UINT64.prototype.addToStream=function(e,n){e.writeUint64(n)},DATATYPE_UINT64.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_UINT64.prototype.isSameType=function(e){return e instanceof UINT64},DATATYPE_UINT64}();KBEngine.DATATYPE_UINT64=DATATYPE_UINT64,__reflect(DATATYPE_UINT64.prototype,"KBEngine.DATATYPE_UINT64");var DATATYPE_INT8=function(){function DATATYPE_INT8(){}return DATATYPE_INT8.prototype.bind=function(){},DATATYPE_INT8.prototype.createFromStream=function(e){return KBEngine.reader.readInt8.call(e)},DATATYPE_INT8.prototype.addToStream=function(e,n){e.writeInt8(n)},DATATYPE_INT8.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_INT8.prototype.isSameType=function(e){return"number"!=typeof e?!1:-128>e||e>127?!1:!0},DATATYPE_INT8}();KBEngine.DATATYPE_INT8=DATATYPE_INT8,__reflect(DATATYPE_INT8.prototype,"KBEngine.DATATYPE_INT8");var DATATYPE_INT16=function(){function DATATYPE_INT16(){}return DATATYPE_INT16.prototype.bind=function(){},DATATYPE_INT16.prototype.createFromStream=function(e){return KBEngine.reader.readInt16.call(e)},DATATYPE_INT16.prototype.addToStream=function(e,n){e.writeInt16(n)},DATATYPE_INT16.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_INT16.prototype.isSameType=function(e){return"number"!=typeof e?!1:-32768>e||e>32767?!1:!0},DATATYPE_INT16}();KBEngine.DATATYPE_INT16=DATATYPE_INT16,__reflect(DATATYPE_INT16.prototype,"KBEngine.DATATYPE_INT16");var DATATYPE_INT32=function(){function DATATYPE_INT32(){}return DATATYPE_INT32.prototype.bind=function(){},DATATYPE_INT32.prototype.createFromStream=function(e){return KBEngine.reader.readInt32.call(e)},DATATYPE_INT32.prototype.addToStream=function(e,n){e.writeInt32(n)},DATATYPE_INT32.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_INT32.prototype.isSameType=function(e){return"number"!=typeof e?!1:-2147483648>e||e>2147483647?!1:!0},DATATYPE_INT32}();KBEngine.DATATYPE_INT32=DATATYPE_INT32,__reflect(DATATYPE_INT32.prototype,"KBEngine.DATATYPE_INT32");var DATATYPE_INT64=function(){function DATATYPE_INT64(){}return DATATYPE_INT64.prototype.bind=function(){},DATATYPE_INT64.prototype.createFromStream=function(e){return KBEngine.reader.readInt64.call(e)},DATATYPE_INT64.prototype.addToStream=function(e,n){e.writeInt64(n)},DATATYPE_INT64.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_INT64.prototype.isSameType=function(e){return e instanceof INT64},DATATYPE_INT64}();KBEngine.DATATYPE_INT64=DATATYPE_INT64,__reflect(DATATYPE_INT64.prototype,"KBEngine.DATATYPE_INT64");var DATATYPE_FLOAT=function(){function DATATYPE_FLOAT(){}return DATATYPE_FLOAT.prototype.bind=function(){},DATATYPE_FLOAT.prototype.createFromStream=function(e){return KBEngine.reader.readFloat.call(e)},DATATYPE_FLOAT.prototype.addToStream=function(e,n){e.writeFloat(n)},DATATYPE_FLOAT.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_FLOAT.prototype.isSameType=function(e){return"number"==typeof e},DATATYPE_FLOAT}();KBEngine.DATATYPE_FLOAT=DATATYPE_FLOAT,__reflect(DATATYPE_FLOAT.prototype,"KBEngine.DATATYPE_FLOAT");var DATATYPE_DOUBLE=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.prototype.createFromStream=function(e){return KBEngine.reader.readDouble.call(e)},n.prototype.addToStream=function(e,n){e.writeDouble(n)},n}(DATATYPE_FLOAT);KBEngine.DATATYPE_DOUBLE=DATATYPE_DOUBLE,__reflect(DATATYPE_DOUBLE.prototype,"KBEngine.DATATYPE_DOUBLE");var DATATYPE_STRING=function(){function DATATYPE_STRING(){}return DATATYPE_STRING.prototype.bind=function(){},DATATYPE_STRING.prototype.createFromStream=function(e){return KBEngine.reader.readString.call(e)},DATATYPE_STRING.prototype.addToStream=function(e,n){e.writeString(n)},DATATYPE_STRING.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_STRING.prototype.isSameType=function(e){return"string"==typeof e},DATATYPE_STRING}();KBEngine.DATATYPE_STRING=DATATYPE_STRING,__reflect(DATATYPE_STRING.prototype,"KBEngine.DATATYPE_STRING");var DATATYPE_VECTOR2=function(){function DATATYPE_VECTOR2(){}return DATATYPE_VECTOR2.prototype.bind=function(){},DATATYPE_VECTOR2.prototype.createFromStream=function(e){return KBEngine.CLIENT_NO_FLOAT?new Vector3(KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e)):new Vector3(KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e))},DATATYPE_VECTOR2.prototype.addToStream=function(e,n){KBEngine.CLIENT_NO_FLOAT?(e.writeInt32(n.x),e.writeInt32(n.y)):(e.writeFloat(n.x),e.writeFloat(n.y))},DATATYPE_VECTOR2.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_VECTOR2.prototype.isSameType=function(e){return e instanceof Vector3?!0:!1},DATATYPE_VECTOR2}();KBEngine.DATATYPE_VECTOR2=DATATYPE_VECTOR2,__reflect(DATATYPE_VECTOR2.prototype,"KBEngine.DATATYPE_VECTOR2");var DATATYPE_VECTOR3=function(){function DATATYPE_VECTOR3(){}return DATATYPE_VECTOR3.prototype.bind=function(){},DATATYPE_VECTOR3.prototype.createFromStream=function(e){return KBEngine.CLIENT_NO_FLOAT?new Vector3(KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e)):new Vector3(KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e))},DATATYPE_VECTOR3.prototype.addToStream=function(e,n){KBEngine.CLIENT_NO_FLOAT?(e.writeInt32(n.x),e.writeInt32(n.y),e.writeInt32(n.z)):(e.writeFloat(n.x),e.writeFloat(n.y),e.writeFloat(n.z))},DATATYPE_VECTOR3.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_VECTOR3.prototype.isSameType=function(e){return e instanceof Vector3?!0:!1},DATATYPE_VECTOR3}();KBEngine.DATATYPE_VECTOR3=DATATYPE_VECTOR3,__reflect(DATATYPE_VECTOR3.prototype,"KBEngine.DATATYPE_VECTOR3");var DATATYPE_VECTOR4=function(){function DATATYPE_VECTOR4(){}return DATATYPE_VECTOR4.prototype.bind=function(){},DATATYPE_VECTOR4.prototype.createFromStream=function(e){return KBEngine.CLIENT_NO_FLOAT?new Vector3(KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e)):new Vector3(KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e))},DATATYPE_VECTOR4.prototype.addToStream=function(e,n){KBEngine.CLIENT_NO_FLOAT?(e.writeInt32(n.x),e.writeInt32(n.y),e.writeInt32(n.z),e.writeInt32(n.w)):(e.writeFloat(n.x),e.writeFloat(n.y),e.writeFloat(n.z),e.writeFloat(n.w))},DATATYPE_VECTOR4.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_VECTOR4.prototype.isSameType=function(e){return e instanceof Vector3?!0:!1},DATATYPE_VECTOR4}();KBEngine.DATATYPE_VECTOR4=DATATYPE_VECTOR4,__reflect(DATATYPE_VECTOR4.prototype,"KBEngine.DATATYPE_VECTOR4");var DATATYPE_PYTHON=function(){function DATATYPE_PYTHON(){}return DATATYPE_PYTHON.prototype.bind=function(){},DATATYPE_PYTHON.prototype.createFromStream=function(e){},DATATYPE_PYTHON.prototype.addToStream=function(e,n){},DATATYPE_PYTHON.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_PYTHON.prototype.isSameType=function(e){return!1},DATATYPE_PYTHON}();KBEngine.DATATYPE_PYTHON=DATATYPE_PYTHON,__reflect(DATATYPE_PYTHON.prototype,"KBEngine.DATATYPE_PYTHON");var DATATYPE_UNICODE=function(){function e(){}return e.prototype.bind=function(){},e.prototype.createFromStream=function(e){return utf8ArrayToString(KBEngine.reader.readBlob.call(e))},e.prototype.addToStream=function(e,n){e.writeBlob(stringToUTF8Bytes(n))},e.prototype.parseDefaultValStr=function(e){return"string"==typeof e?e:""},e.prototype.isSameType=function(e){return"string"==typeof e},e}();KBEngine.DATATYPE_UNICODE=DATATYPE_UNICODE,__reflect(DATATYPE_UNICODE.prototype,"KBEngine.DATATYPE_UNICODE");var DATATYPE_ENTITYCALL=function(){function DATATYPE_ENTITYCALL(){}return DATATYPE_ENTITYCALL.prototype.bind=function(){},DATATYPE_ENTITYCALL.prototype.createFromStream=function(e){},DATATYPE_ENTITYCALL.prototype.addToStream=function(e,n){},DATATYPE_ENTITYCALL.prototype.parseDefaultValStr=function(v){return eval(v)
},DATATYPE_ENTITYCALL.prototype.isSameType=function(e){return!1},DATATYPE_ENTITYCALL}();KBEngine.DATATYPE_ENTITYCALL=DATATYPE_ENTITYCALL,__reflect(DATATYPE_ENTITYCALL.prototype,"KBEngine.DATATYPE_ENTITYCALL");var DATATYPE_BLOB=function(){function DATATYPE_BLOB(){}return DATATYPE_BLOB.prototype.bind=function(){},DATATYPE_BLOB.prototype.createFromStream=function(e){var n=KBEngine.reader.readUint32.call(e),t=new Uint8Array(e.buffer,e.rpos,n);return e.rpos+=n,t},DATATYPE_BLOB.prototype.addToStream=function(e,n){e.writeBlob(n)},DATATYPE_BLOB.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_BLOB.prototype.isSameType=function(e){return!0},DATATYPE_BLOB}();KBEngine.DATATYPE_BLOB=DATATYPE_BLOB,__reflect(DATATYPE_BLOB.prototype,"KBEngine.DATATYPE_BLOB");var DATATYPE_ARRAY=function(){function DATATYPE_ARRAY(){this.type=null}return DATATYPE_ARRAY.prototype.bind=function(){"number"==typeof this.type&&(this.type=datatypes[this.type])},DATATYPE_ARRAY.prototype.createFromStream=function(e){for(var n=e.readUint32(),t=[];n>0;)n--,t.push(this.type.createFromStream(e));return t},DATATYPE_ARRAY.prototype.addToStream=function(e,n){e.writeUint32(n.length);for(var t=0;t<n.length;t++)this.type.addToStream(e,n[t])},DATATYPE_ARRAY.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_ARRAY.prototype.isSameType=function(e){for(var n=0;n<e.length;n++)if(!this.type.isSameType(e[n]))return!1;return!0},DATATYPE_ARRAY}();KBEngine.DATATYPE_ARRAY=DATATYPE_ARRAY,__reflect(DATATYPE_ARRAY.prototype,"KBEngine.DATATYPE_ARRAY");var DATATYPE_FIXED_DICT=function(){function DATATYPE_FIXED_DICT(){this.dicttype={},this.implementedBy=null}return DATATYPE_FIXED_DICT.prototype.bind=function(){for(var e in this.dicttype){var n=this.dicttype[e];"number"==typeof this.dicttype[e]&&(this.dicttype[e]=datatypes[n])}},DATATYPE_FIXED_DICT.prototype.createFromStream=function(e){var n={};for(var t in this.dicttype)n[t]=this.dicttype[t].createFromStream(e);return n},DATATYPE_FIXED_DICT.prototype.addToStream=function(e,n){for(var t in this.dicttype)this.dicttype[t].addToStream(e,n[t])},DATATYPE_FIXED_DICT.prototype.parseDefaultValStr=function(v){return eval(v)},DATATYPE_FIXED_DICT.prototype.isSameType=function(e){for(var n in this.dicttype)if(!this.dicttype[n].isSameType(e[n]))return!1;return!0},DATATYPE_FIXED_DICT}();KBEngine.DATATYPE_FIXED_DICT=DATATYPE_FIXED_DICT,__reflect(DATATYPE_FIXED_DICT.prototype,"KBEngine.DATATYPE_FIXED_DICT");var datatypes;!function(e){e.UINT8=new DATATYPE_UINT8,e.UINT16=new DATATYPE_UINT16,e.UINT32=new DATATYPE_UINT32,e.UINT64=new DATATYPE_UINT64,e.INT8=new DATATYPE_INT8,e.INT16=new DATATYPE_INT16,e.INT32=new DATATYPE_INT32,e.INT64=new DATATYPE_INT64,e.FLOAT=new DATATYPE_FLOAT,e.DOUBLE=new DATATYPE_DOUBLE,e.STRING=new DATATYPE_STRING,e.VECTOR2=new DATATYPE_VECTOR2,e.VECTOR3=new DATATYPE_VECTOR3,e.VECTOR4=new DATATYPE_VECTOR4,e.PYTHON=new DATATYPE_PYTHON,e.UNICODE=new DATATYPE_UNICODE,e.ENTITYCALL=new DATATYPE_ENTITYCALL,e.BLOB=new DATATYPE_BLOB}(datatypes=KBEngine.datatypes||(KBEngine.datatypes={}));var KBEngineArgs=function(){function e(){this.ip="127.0.0.1",this.port=20013,this.updateHZ=100,this.serverHeartbeatTick=15,this.clientType=5,this.isOnInitCallPropertysSetMethods=!0}return e}();KBEngine.KBEngineArgs=KBEngineArgs,__reflect(KBEngineArgs.prototype,"KBEngine.KBEngineArgs");var KBEngineApp=function(){function KBEngineApp(e){this.username="testhtml51",this.password="123456",this.clientdatas="",this.encryptedKey="",this.loginappMessageImported=!1,this.baseappMessageImported=!1,this.serverErrorsDescrImported=!1,this.entitydefImported=!1,this.serverErrs={},this.baseappIP="",this.baseappPort=0,this.currstate="create",this.serverdatas="",this.serverVersion="",this.serverScriptVersion="",this.serverProtocolMD5="",this.serverEntityDefMD5="",this.clientVersion="1.1.5",this.clientScriptVersion="0.1.0",this.entity_uuid=null,this.entity_id=0,this.entity_type="",this.entityServerPos=new Vector3(0,0,0),this.entities={},this.entityIDAliasIDList=[],this.controlledEntities=[],this.spacedata={},this.spaceID=0,this.spaceResPath="",this.isLoadedGeometry=!1,this.lastTickTime=Date.now(),this.lastTickCBTime=Date.now(),this.entityclass={},console.assert(null==KBEngine.app||void 0==KBEngine.app,"Assertion of app not is null"),KBEngine.app=this,this.args=e}return KBEngineApp.prototype.resetSocket=function(){try{if(void 0!=KBEngine.app.socket&&null!=KBEngine.app.socket){var e=KBEngine.app.socket;e.onopen=void 0,e.onerror=void 0,e.onmessage=void 0,e.onclose=void 0,KBEngine.app.socket=null,e.close()}}catch(n){}},KBEngineApp.prototype.reset=function(){void 0!=KBEngine.app.entities&&null!=KBEngine.app.entities&&KBEngine.app.clearEntities(!0),KBEngine.app.resetSocket(),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="create",KBEngine.app.serverdatas="",KBEngine.app.serverVersion="",KBEngine.app.serverScriptVersion="",KBEngine.app.serverProtocolMD5="",KBEngine.app.serverEntityDefMD5="",KBEngine.app.clientVersion="1.1.5",KBEngine.app.clientScriptVersion="0.1.0",KBEngine.app.entity_uuid=null,KBEngine.app.entity_id=0,KBEngine.app.entity_type="",KBEngine.app.entityServerPos=new Vector3(0,0,0),KBEngine.app.entities={},KBEngine.app.entityIDAliasIDList=[],KBEngine.app.controlledEntities=[],KBEngine.app.spacedata={},KBEngine.app.spaceID=0,KBEngine.app.spaceResPath="",KBEngine.app.isLoadedGeometry=!1;var e=new Date;KBEngine.app.lastTickTime=e.getTime(),KBEngine.app.lastTickCBTime=e.getTime(),mappingDataType(),KBEngine.app.component="client"},KBEngineApp.prototype.installEvents=function(){KBEngine.Event.register("createAccount",KBEngine.app,"createAccount"),KBEngine.Event.register("login",KBEngine.app,"login"),KBEngine.Event.register("reloginBaseapp",KBEngine.app,"reloginBaseapp"),KBEngine.Event.register("bindAccountEmail",KBEngine.app,"bindAccountEmail"),KBEngine.Event.register("newPassword",KBEngine.app,"newPassword")},KBEngineApp.prototype.uninstallEvents=function(){KBEngine.Event.deregister("reloginBaseapp",KBEngine.app),KBEngine.Event.deregister("login",KBEngine.app),KBEngine.Event.deregister("createAccount",KBEngine.app)},KBEngineApp.prototype.hello=function(){var e=new Bundle;"loginapp"==KBEngine.app.currserver?e.newMessage(messages.Loginapp_hello):e.newMessage(messages.Baseapp_hello),e.writeString(KBEngine.app.clientVersion),e.writeString(KBEngine.app.clientScriptVersion),e.writeBlob(KBEngine.app.encryptedKey),e.send(KBEngine.app)},KBEngineApp.prototype.player=function(){return KBEngine.app.entities[KBEngine.app.entity_id]},KBEngineApp.prototype.findEntity=function(e){return KBEngine.app.entities[e]},KBEngineApp.prototype.connect=function(e){console.assert(null==KBEngine.app.socket,"Assertion of socket not is null");try{KBEngine.app.socket=new WebSocket(e)}catch(n){return ERROR_MSG("WebSocket init error!"),void KBEngine.Event.fire("onConnectionState",!1)}KBEngine.app.socket.binaryType="arraybuffer",KBEngine.app.socket.onopen=KBEngine.app.onopen,KBEngine.app.socket.onerror=KBEngine.app.onerror_before_onopen,KBEngine.app.socket.onmessage=KBEngine.app.onmessage,KBEngine.app.socket.onclose=KBEngine.app.onclose},KBEngineApp.prototype.disconnect=function(){KBEngine.app.resetSocket()},KBEngineApp.prototype.onopen=function(){INFO_MSG("connect success!"),KBEngine.app.socket.onerror=KBEngine.app.onerror_after_onopen,KBEngine.Event.fire("onConnectionState",!0)},KBEngineApp.prototype.onerror_before_onopen=function(e){ERROR_MSG("connect error:"+e.data),KBEngine.app.resetSocket(),KBEngine.Event.fire("onConnectionState",!1)},KBEngineApp.prototype.onerror_after_onopen=function(e){ERROR_MSG("connect error:"+e.data),KBEngine.app.resetSocket(),KBEngine.Event.fire("onDisconnected")},KBEngineApp.prototype.onmessage=function(e){var n=new MemoryStream(e.data);for(n.wpos=e.data.byteLength;n.rpos<n.wpos;){var t=n.readUint16(),i=KBEngine.clientmessages[t];if(i){var r=i.length;-1==r&&(r=n.readUint16(),65535==r&&(r=n.readUint32()));var a=n.wpos,p=n.rpos+r;n.wpos=p,i.handleMessage(n),n.wpos=a,n.rpos=p}else ERROR_MSG("KBEngineApp::onmessage["+KBEngine.app.currserver+"]: not found msg("+t+")!")}},KBEngineApp.prototype.onclose=function(){INFO_MSG("connect close:"+KBEngine.app.currserver),KBEngine.app.resetSocket(),KBEngine.Event.fire("onDisconnected")},KBEngineApp.prototype.send=function(e){KBEngine.app.socket.send(e)},KBEngineApp.prototype.close=function(){INFO_MSG("KBEngine::close()"),KBEngine.app.socket.close(),KBEngine.app.reset()},KBEngineApp.prototype.update=function(){if(null!=KBEngine.app.socket){var e=new Date;if((e.getTime()-KBEngine.app.lastTickTime)/1e3>KBEngine.app.args.serverHeartbeatTick){if(KBEngine.app.lastTickCBTime<KBEngine.app.lastTickTime&&(ERROR_MSG("sendTick: Receive appTick timeout!"),KBEngine.app.socket.close()),"loginapp"==KBEngine.app.currserver){if(void 0!=messages.Loginapp_onClientActiveTick){var n=new Bundle;n.newMessage(messages.Loginapp_onClientActiveTick),n.send(KBEngine.app)}}else if(void 0!=messages.Baseapp_onClientActiveTick){var n=new Bundle;n.newMessage(messages.Baseapp_onClientActiveTick),n.send(KBEngine.app)}KBEngine.app.lastTickTime=e.getTime()}KBEngine.app.updatePlayerToServer()}},KBEngineApp.prototype.Client_onAppActiveTickCB=function(){var e=new Date;KBEngine.app.lastTickCBTime=e.getTime()},KBEngineApp.prototype.serverErr=function(e){var n=KBEngine.app.serverErrs[e];return void 0==n?"":n.name+" ["+n.descr+"]"},KBEngineApp.prototype.Client_onImportServerErrorsDescr=function(e){for(var n=e.readUint16();n>0;){n-=1;var t=new ServerErr;t.id=e.readUint16(),t.name=utf8ArrayToString(e.readBlob()),t.descr=utf8ArrayToString(e.readBlob()),KBEngine.app.serverErrs[t.id]=t,INFO_MSG("Client_onImportServerErrorsDescr: id="+t.id+", name="+t.name+", descr="+t.descr)}},KBEngineApp.prototype.onOpenLoginapp_login=function(){if(INFO_MSG("KBEngineApp::onOpenLoginapp_login: successfully!"),KBEngine.Event.fire("onConnectionState",!0),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="login",KBEngine.app.loginappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new Bundle;e.newMessage(messages.Loginapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,INFO_MSG("KBEngineApp::onOpenLoginapp_login: start importClientMessages ..."),KBEngine.Event.fire("Loginapp_importClientMessages")}},KBEngineApp.prototype.onOpenLoginapp_createAccount=function(){if(KBEngine.Event.fire("onConnectionState",!0),INFO_MSG("KBEngineApp::onOpenLoginapp_createAccount: successfully!"),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="createAccount",KBEngine.app.loginappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new Bundle;e.newMessage(messages.Loginapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,INFO_MSG("KBEngineApp::onOpenLoginapp_createAccount: start importClientMessages ..."),KBEngine.Event.fire("Loginapp_importClientMessages")}},KBEngineApp.prototype.onImportClientMessagesCompleted=function(){if(INFO_MSG("KBEngineApp::onImportClientMessagesCompleted: successfully!"),KBEngine.app.socket.onmessage=KBEngine.app.onmessage,KBEngine.app.hello(),"loginapp"==KBEngine.app.currserver){if(!KBEngine.app.serverErrorsDescrImported){INFO_MSG("KBEngine::onImportClientMessagesCompleted(): send importServerErrorsDescr!"),KBEngine.app.serverErrorsDescrImported=!0;var e=new Bundle;e.newMessage(messages.Loginapp_importServerErrorsDescr),e.send(KBEngine.app)}"login"==KBEngine.app.currstate?KBEngine.app.login_loginapp(!1):"resetpassword"==KBEngine.app.currstate?KBEngine.app.resetpassword_loginapp(!1):KBEngine.app.createAccount_loginapp(!1),KBEngine.app.loginappMessageImported=!0}else if(KBEngine.app.baseappMessageImported=!0,KBEngine.app.entitydefImported)KBEngine.app.onImportEntityDefCompleted();else{INFO_MSG("KBEngineApp::onImportClientMessagesCompleted: start importEntityDef ...");var e=new Bundle;e.newMessage(messages.Baseapp_importClientEntityDef),e.send(KBEngine.app),KBEngine.Event.fire("Baseapp_importClientEntityDef")}},KBEngineApp.prototype.createDataTypeFromStreams=function(e,n){var t=e.readUint16();for(INFO_MSG("KBEngineApp::createDataTypeFromStreams: importAlias(size="+t+")!");t>0;)t--,KBEngine.app.createDataTypeFromStream(e,n);for(var i in datatypes)void 0!=datatypes[i]&&datatypes[i].bind()},KBEngineApp.prototype.createDataTypeFromStream=function(e,n){var t,i=e.readUint16(),r=e.readString(),a=e.readString();if(0==a.length&&(t="Null_"+i),n&&INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: importAlias("+r+":"+a+")!"),"FIXED_DICT"==r){var p=new DATATYPE_FIXED_DICT,o=e.readUint8();for(p.implementedBy=e.readString();o>0;){o--;var s=e.readString(),E=e.readUint16();p.dicttype[s]=E}datatypes[a]=p}else if("ARRAY"==r){var g=e.readUint16(),p=new DATATYPE_ARRAY;p.type=g,datatypes[a]=p}else datatypes[a]=datatypes[r];datatypes[i]=datatypes[a],KBEngine.datatype2id[a]=i},KBEngineApp.prototype.Client_onImportClientEntityDef=function(stream){for(KBEngine.app.createDataTypeFromStreams(stream,!0);!stream.readEOF();){var scriptmodule_name=stream.readString(),scriptUtype=stream.readUint16(),propertysize=stream.readUint16(),methodsize=stream.readUint16(),base_methodsize=stream.readUint16(),cell_methodsize=stream.readUint16();INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: import("+scriptmodule_name+"), propertys("+propertysize+"), clientMethods("+methodsize+"), baseMethods("+base_methodsize+"), cellMethods("+cell_methodsize+")!"),KBEngine.moduledefs[scriptmodule_name]={};var currModuleDefs=KBEngine.moduledefs[scriptmodule_name];currModuleDefs.name=scriptmodule_name,currModuleDefs.propertys={},currModuleDefs.methods={},currModuleDefs.base_methods={},currModuleDefs.cell_methods={},KBEngine.moduledefs[scriptUtype]=currModuleDefs;var self_propertys=currModuleDefs.propertys,self_methods=currModuleDefs.methods,self_base_methods=currModuleDefs.base_methods,self_cell_methods=currModuleDefs.cell_methods;try{var Class_1=eval(""+scriptmodule_name)}catch(e){var Class_2=void 0}for(;propertysize>0;){propertysize--;var properUtype=stream.readUint16(),properFlags=stream.readUint32(),aliasID=stream.readInt16(),name_2=stream.readString(),defaultValStr=stream.readString(),utype=datatypes[stream.readUint16()],setmethod=null;void 0!=Class&&(setmethod=Class.prototype["set_"+name_2],void 0==setmethod&&(setmethod=null));var savedata=[properUtype,aliasID,name_2,defaultValStr,utype,setmethod,properFlags];self_propertys[name_2]=savedata,-1!=aliasID?(self_propertys[aliasID]=savedata,currModuleDefs.usePropertyDescrAlias=!0):(self_propertys[properUtype]=savedata,currModuleDefs.usePropertyDescrAlias=!1),INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), property("+name_2+"/"+properUtype+").")}for(;methodsize>0;){methodsize--;for(var methodUtype=stream.readUint16(),aliasID=stream.readInt16(),name_3=stream.readString(),argssize=stream.readUint8(),args=[];argssize>0;)argssize--,args.push(datatypes[stream.readUint16()]);var savedata=[methodUtype,aliasID,name_3,args];self_methods[name_3]=savedata,-1!=aliasID?(self_methods[aliasID]=savedata,currModuleDefs.useMethodDescrAlias=!0):(self_methods[methodUtype]=savedata,currModuleDefs.useMethodDescrAlias=!1),INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), method("+name_3+").")}for(;base_methodsize>0;){base_methodsize--;for(var methodUtype=stream.readUint16(),aliasID=stream.readInt16(),name_4=stream.readString(),argssize=stream.readUint8(),args=[];argssize>0;)argssize--,args.push(datatypes[stream.readUint16()]);self_base_methods[name_4]=[methodUtype,aliasID,name_4,args],INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), base_method("+name_4+").")}for(;cell_methodsize>0;){cell_methodsize--;for(var methodUtype=stream.readUint16(),aliasID=stream.readInt16(),name_5=stream.readString(),argssize=stream.readUint8(),args=[];argssize>0;)argssize--,args.push(datatypes[stream.readUint16()]);self_cell_methods[name_5]=[methodUtype,aliasID,name_5,args],INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), cell_method("+name_5+").")}var defmethod=void 0;try{defmethod=eval(""+scriptmodule_name)}catch(e){ERROR_MSG("KBEngineApp::Client_onImportClientEntityDef: module("+scriptmodule_name+") not found!"),defmethod=void 0}for(var name_6 in currModuleDefs.propertys){var infos=currModuleDefs.propertys[name_6],properUtype=infos[0],aliasID=infos[1],n=infos[2],defaultValStr=infos[3],utype=infos[4];void 0!=defmethod&&(defmethod.prototype[n]=utype.parseDefaultValStr(defaultValStr))}for(var name_7 in currModuleDefs.methods){var infos=currModuleDefs.methods[name_7],properUtype=infos[0],aliasID=infos[1],n=infos[2],args=infos[3];void 0!=defmethod&&void 0==defmethod.prototype[n]&&WARNING_MSG(scriptmodule_name+":: method("+n+") no implement!")}}KBEngine.app.onImportEntityDefCompleted()},KBEngineApp.prototype.Client_onVersionNotMatch=function(e){KBEngine.app.serverVersion=e.readString(),ERROR_MSG("Client_onVersionNotMatch: verInfo="+KBEngine.app.clientVersion+" not match(server: "+KBEngine.app.serverVersion+")"),KBEngine.Event.fire("onVersionNotMatch",KBEngine.app.clientVersion,KBEngine.app.serverVersion)},KBEngineApp.prototype.Client_onScriptVersionNotMatch=function(e){KBEngine.app.serverScriptVersion=e.readString(),ERROR_MSG("Client_onScriptVersionNotMatch: verInfo="+KBEngine.app.clientScriptVersion+" not match(server: "+KBEngine.app.serverScriptVersion+")"),KBEngine.Event.fire("onScriptVersionNotMatch",KBEngine.app.clientScriptVersion,KBEngine.app.serverScriptVersion)},KBEngineApp.prototype.onImportEntityDefCompleted=function(){INFO_MSG("KBEngineApp::onImportEntityDefCompleted: successfully!"),KBEngine.app.entitydefImported=!0,KBEngine.app.login_baseapp(!1)},KBEngineApp.prototype.Client_onImportClientMessages=function(e){var n=new MemoryStream(e.data),t=n.readUint16();if(t==messages.onImportClientMessages.id){var i=n.readUint16(),r=n.readUint16();for(INFO_MSG("KBEngineApp::onImportClientMessages: start("+r+") ...!");r>0;){r--,t=n.readUint16(),i=n.readInt16();for(var a=n.readString(),p=n.readInt8(),o=n.readUint8(),s=new Array(o),E=0;o>E;E++)s[E]=n.readUint8();var g=null,l=a.indexOf("Client_")>=0;l&&(g=KBEngine.app[a],null==g||void 0==g?(WARNING_MSG("KBEngineApp::onImportClientMessages["+KBEngine.app.currserver+"]: interface("+a+"/"+t+") no implement!"),g=null):INFO_MSG("KBEngineApp::onImportClientMessages: import("+a+") successfully!")),a.length>0?(messages[a]=new Message(t,a,i,p,s,g),l?KBEngine.clientmessages[t]=messages[a]:messages[KBEngine.app.currserver][t]=messages[a]):messages[KBEngine.app.currserver][t]=new Message(t,a,i,p,s,g)}KBEngine.app.onImportClientMessagesCompleted()}else ERROR_MSG("KBEngineApp::onmessage: not found msg("+t+")!")},KBEngineApp.prototype.createAccount=function(e,n,t){KBEngine.app.reset(),KBEngine.app.username=e,KBEngine.app.password=n,KBEngine.app.clientdatas=t,KBEngine.app.createAccount_loginapp(!0)},KBEngineApp.prototype.createAccount_loginapp=function(e){if(e)INFO_MSG("KBEngineApp::createAccount_loginapp: start connect to ws://"+KBEngine.app.ip+":"+KBEngine.app.port+"!"),KBEngine.app.connect("ws://"+KBEngine.app.ip+":"+KBEngine.app.port),KBEngine.app.socket.onopen=KBEngine.app.onOpenLoginapp_createAccount;else{var n=new Bundle;n.newMessage(messages.Loginapp_reqCreateAccount),n.writeString(KBEngine.app.username),n.writeString(KBEngine.app.password),n.writeBlob(KBEngine.app.clientdatas),n.send(KBEngine.app)}},KBEngineApp.prototype.bindAccountEmail=function(e){var n=new Bundle;n.newMessage(messages.Baseapp_reqAccountBindEmail),n.writeInt32(KBEngine.app.entity_id),n.writeString(KBEngine.app.password),n.writeString(e),n.send(KBEngine.app)},KBEngineApp.prototype.newPassword=function(e,n){var t=new Bundle;t.newMessage(messages.Baseapp_reqAccountNewPassword),t.writeInt32(KBEngine.app.entity_id),t.writeString(e),t.writeString(n),t.send(KBEngine.app)},KBEngineApp.prototype.login=function(e,n,t){KBEngine.app.reset(),KBEngine.app.username=e,KBEngine.app.password=n,KBEngine.app.clientdatas=t,KBEngine.app.login_loginapp(!0)},KBEngineApp.prototype.login_loginapp=function(e){if(e)INFO_MSG("KBEngineApp::login_loginapp: start connect to ws://"+KBEngine.app.ip+":"+KBEngine.app.port+"!"),KBEngine.app.connect("ws://"+KBEngine.app.ip+":"+KBEngine.app.port),KBEngine.app.socket.onopen=KBEngine.app.onOpenLoginapp_login;else{var n=new Bundle;n.newMessage(messages.Loginapp_login),n.writeInt8(KBEngine.app.args.clientType),n.writeBlob(KBEngine.app.clientdatas),n.writeString(KBEngine.app.username),n.writeString(KBEngine.app.password),n.send(KBEngine.app)}},KBEngineApp.prototype.onOpenLoginapp_resetpassword=function(){if(INFO_MSG("KBEngineApp::onOpenLoginapp_resetpassword: successfully!"),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="resetpassword",KBEngine.app.loginappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new Bundle;e.newMessage(messages.Loginapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,INFO_MSG("KBEngineApp::onOpenLoginapp_resetpassword: start importClientMessages ...")}},KBEngineApp.prototype.reset_password=function(e){KBEngine.app.reset(),KBEngine.app.username=e,KBEngine.app.resetpassword_loginapp(!0)},KBEngineApp.prototype.resetpassword_loginapp=function(e){if(e)INFO_MSG("KBEngineApp::createAccount_loginapp: start connect to ws://"+KBEngine.app.ip+":"+KBEngine.app.port+"!"),KBEngine.app.connect("ws://"+KBEngine.app.ip+":"+KBEngine.app.port),KBEngine.app.socket.onopen=KBEngine.app.onOpenLoginapp_resetpassword;else{var n=new Bundle;n.newMessage(messages.Loginapp_reqAccountResetPassword),n.writeString(KBEngine.app.username),n.send(KBEngine.app)}},KBEngineApp.prototype.onOpenBaseapp=function(){if(INFO_MSG("KBEngineApp::onOpenBaseapp: successfully!"),KBEngine.app.currserver="baseapp",KBEngine.app.baseappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new Bundle;e.newMessage(messages.Baseapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,KBEngine.Event.fire("Baseapp_importClientMessages")}},KBEngineApp.prototype.login_baseapp=function(e){if(e)KBEngine.Event.fire("onLoginBaseapp"),INFO_MSG("KBEngineApp::login_baseapp: start connect to ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort+"!"),KBEngine.app.connect("ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort),void 0!=KBEngine.app.socket&&null!=KBEngine.app.socket&&(KBEngine.app.socket.onopen=KBEngine.app.onOpenBaseapp);else{var n=new Bundle;n.newMessage(messages.Baseapp_loginBaseapp),n.writeString(KBEngine.app.username),n.writeString(KBEngine.app.password),n.send(KBEngine.app)}},KBEngineApp.prototype.reloginBaseapp=function(){(void 0==KBEngine.app.socket||null==KBEngine.app.socket)&&(KBEngine.app.resetSocket(),KBEngine.Event.fire("onReloginBaseapp"),INFO_MSG("KBEngineApp::reloginBaseapp: start connect to ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort+"!"),KBEngine.app.connect("ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort),void 0!=KBEngine.app.socket&&null!=KBEngine.app.socket&&(KBEngine.app.socket.onopen=KBEngine.app.onReOpenBaseapp))},KBEngineApp.prototype.onReOpenBaseapp=function(){INFO_MSG("KBEngineApp::onReOpenBaseapp: successfully!"),KBEngine.app.currserver="baseapp";var e=new Bundle;e.newMessage(messages.Baseapp_reloginBaseapp),e.writeString(KBEngine.app.username),e.writeString(KBEngine.app.password),e.writeUint64(KBEngine.app.entity_uuid),e.writeInt32(KBEngine.app.entity_id),e.send(KBEngine.app);var n=new Date;KBEngine.app.lastTickCBTime=n.getTime()},KBEngineApp.prototype.Client_onHelloCB=function(e){KBEngine.app.serverVersion=e.readString(),KBEngine.app.serverScriptVersion=e.readString(),KBEngine.app.serverProtocolMD5=e.readString(),KBEngine.app.serverEntityDefMD5=e.readString();var n=e.readInt32();INFO_MSG("KBEngineApp::Client_onHelloCB: verInfo("+KBEngine.app.serverVersion+"), scriptVerInfo("+KBEngine.app.serverScriptVersion+"), serverProtocolMD5("+KBEngine.app.serverProtocolMD5+"), serverEntityDefMD5("+KBEngine.app.serverEntityDefMD5+"), ctype("+n+")!");var t=new Date;KBEngine.app.lastTickCBTime=t.getTime()},KBEngineApp.prototype.Client_onLoginFailed=function(e){var n=e.readUint16();KBEngine.app.serverdatas=e.readBlob(),ERROR_MSG("KBEngineApp::Client_onLoginFailed: failedcode("+KBEngine.app.serverErrs[n].name+"), datas("+KBEngine.app.serverdatas.length+")!"),KBEngine.Event.fire("onLoginFailed",n)},KBEngineApp.prototype.Client_onLoginSuccessfully=function(e){var n=e.readString();KBEngine.app.username=n,KBEngine.app.baseappIp=e.readString(),KBEngine.app.baseappPort=e.readUint16(),KBEngine.app.serverdatas=e.readBlob(),INFO_MSG("KBEngineApp::Client_onLoginSuccessfully: accountName("+n+"), addr("+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort+"), datas("+KBEngine.app.serverdatas.length+")!"),KBEngine.app.disconnect(),KBEngine.app.login_baseapp(!0)},KBEngineApp.prototype.Client_onLoginBaseappFailed=function(e){ERROR_MSG("KBEngineApp::Client_onLoginBaseappFailed: failedcode("+KBEngine.app.serverErrs[e].name+")!"),KBEngine.Event.fire("onLoginBaseappFailed",e)},KBEngineApp.prototype.Client_onReloginBaseappFailed=function(e){ERROR_MSG("KBEngineApp::Client_onReloginBaseappFailed: failedcode("+KBEngine.app.serverErrs[e].name+")!"),KBEngine.Event.fire("onReloginBaseappFailed",e)},KBEngineApp.prototype.Client_onReloginBaseappSuccessfully=function(e){KBEngine.app.entity_uuid=e.readUint64(),DEBUG_MSG("KBEngineApp::Client_onReloginBaseappSuccessfully: "+KBEngine.app.username),KBEngine.Event.fire("onReloginBaseappSuccessfully")},KBEngineApp.prototype.getentityclass=function(entityType){var runclass=KBEngine.app.entityclass[entityType];if(void 0==runclass){if(runclass=eval(""+entityType),void 0==runclass)return ERROR_MSG("KBEngineApp::getentityclass: entityType("+entityType+") is error!"),runclass;KBEngine.app.entityclass[entityType]=runclass}return runclass},KBEngineApp.prototype.Client_onCreatedProxies=function(e,n,t){INFO_MSG("KBEngineApp::Client_onCreatedProxies: eid("+n+"), entityType("+t+")!");var i=KBEngine.app.entities[n];if(KBEngine.app.entity_uuid=e,KBEngine.app.entity_id=n,void 0==i){var r=KBEngine.app.getentityclass(t);if(void 0==r)return;var a=new r;a.id=n,a.className=t,a.base=new EntityCall,a.base.id=n,a.base.className=t,a.base.type=KBEngine.ENTITYCALL_TYPE_BASE,KBEngine.app.entities[n]=a;var p=KBEngine.bufferedCreateEntityMessage[n];void 0!=p&&(KBEngine.app.Client_onUpdatePropertys(p),delete KBEngine.bufferedCreateEntityMessage[n]),a.__init__(),a.inited=!0,KBEngine.app.args.isOnInitCallPropertysSetMethods&&a.callPropertysSetMethods()}else{var p=KBEngine.bufferedCreateEntityMessage[n];void 0!=p&&(KBEngine.app.Client_onUpdatePropertys(p),delete KBEngine.bufferedCreateEntityMessage[n])}},KBEngineApp.prototype.getViewEntityIDFromStream=function(e){var n=0;if(KBEngine.app.entityIDAliasIDList.length>255)n=e.readInt32();else{var t=e.readUint8();if(KBEngine.app.entityIDAliasIDList.length<=t)return 0;n=KBEngine.app.entityIDAliasIDList[t]}return n},KBEngineApp.prototype.onUpdatePropertys_=function(e,n){var t=KBEngine.app.entities[e];if(void 0==t){var i=KBEngine.bufferedCreateEntityMessage[e];if(void 0!=i)return void ERROR_MSG("KBEngineApp::Client_onUpdatePropertys: entity("+e+") not found!");var r=new MemoryStream(n.buffer);return r.wpos=n.wpos,r.rpos=n.rpos-4,void(KBEngine.bufferedCreateEntityMessage[e]=r)}for(var a=KBEngine.moduledefs[t.className],p=a.propertys;n.length()>0;){var o=0;o=a.usePropertyDescrAlias?n.readUint8():n.readUint16();var s=p[o],E=s[5],g=s[6],l=s[4].createFromStream(n),d=t[s[2]];INFO_MSG("KBEngineApp::Client_onUpdatePropertys: "+t.className+"(id="+e+" "+s[2]+", val="+l+")!"),t[s[2]]=l,null!=E&&(32==g||64==g?t.inited&&E.call(t,d):t.inWorld&&E.call(t,d))}},KBEngineApp.prototype.Client_onUpdatePropertysOptimized=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e);KBEngine.app.onUpdatePropertys_(n,e)},KBEngineApp.prototype.Client_onUpdatePropertys=function(e){var n=e.readInt32();KBEngine.app.onUpdatePropertys_(n,e)},KBEngineApp.prototype.onRemoteMethodCall_=function(e,n){var t=KBEngine.app.entities[e];if(void 0==t)return void ERROR_MSG("KBEngineApp::Client_onRemoteMethodCall: entity("+e+") not found!");var i=0;i=KBEngine.moduledefs[t.className].useMethodDescrAlias?n.readUint8():n.readUint16();for(var r=KBEngine.moduledefs[t.className].methods[i],a=[],p=r[3],o=0;o<p.length;o++)a.push(p[o].createFromStream(n));void 0!=t[r[2]]?t[r[2]].apply(t,a):ERROR_MSG("KBEngineApp::Client_onRemoteMethodCall: entity("+e+") not found method("+r[2]+")!")},KBEngineApp.prototype.Client_onRemoteMethodCallOptimized=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e);KBEngine.app.onRemoteMethodCall_(n,e)},KBEngineApp.prototype.Client_onRemoteMethodCall=function(e){var n=e.readInt32();KBEngine.app.onRemoteMethodCall_(n,e)},KBEngineApp.prototype.Client_onEntityEnterWorld=function(e){var n=e.readInt32();KBEngine.app.entity_id>0&&n!=KBEngine.app.entity_id&&KBEngine.app.entityIDAliasIDList.push(n);var t;t=KBEngine.moduledefs.Length>255?e.readUint16():e.readUint8();var i=!0;e.length()>0&&(i=e.readInt8()),t=KBEngine.moduledefs[t].name,INFO_MSG("KBEngineApp::Client_onEntityEnterWorld: "+t+"("+n+"), spaceID("+KBEngine.app.spaceID+"), isOnGround("+i+")!");var r=KBEngine.app.entities[n];if(void 0==r){var a=KBEngine.bufferedCreateEntityMessage[n];if(void 0==a)return void ERROR_MSG("KBEngineApp::Client_onEntityEnterWorld: entity("+n+") not found!");var p=KBEngine.app.getentityclass(t);if(void 0==p)return;var o=new p;o.id=n,o.className=t,o.cell=new EntityCall,o.cell.id=n,o.cell.className=t,o.cell.type=KBEngine.ENTITYCALL_TYPE_CELL,KBEngine.app.entities[n]=o,KBEngine.app.Client_onUpdatePropertys(a),delete KBEngine.bufferedCreateEntityMessage[n],o.isOnGround=i,o.__init__(),o.inited=!0,o.inWorld=!0,o.enterWorld(),KBEngine.app.args.isOnInitCallPropertysSetMethods&&o.callPropertysSetMethods(),o.set_direction(o.direction),o.set_position(o.position)}else r.inWorld||(r.cell=new EntityCall,r.cell.id=n,r.cell.className=t,r.cell.type=KBEngine.ENTITYCALL_TYPE_CELL,KBEngine.app.entityIDAliasIDList=[],KBEngine.app.entities={},KBEngine.app.entities[r.id]=r,r.set_direction(r.direction),r.set_position(r.position),KBEngine.app.entityServerPos.x=r.position.x,KBEngine.app.entityServerPos.y=r.position.y,KBEngine.app.entityServerPos.z=r.position.z,r.isOnGround=i,r.inWorld=!0,r.enterWorld(),KBEngine.app.args.isOnInitCallPropertysSetMethods&&r.callPropertysSetMethods())},KBEngineApp.prototype.Client_onEntityLeaveWorldOptimized=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e);KBEngine.app.Client_onEntityLeaveWorld(n)},KBEngineApp.prototype.Client_onEntityLeaveWorld=function(e){var n=KBEngine.app.entities[e];if(void 0==n)return void ERROR_MSG("KBEngineApp::Client_onEntityLeaveWorld: entity("+e+") not found!");if(n.inWorld&&n.leaveWorld(),KBEngine.app.entity_id>0&&e!=KBEngine.app.entity_id){for(var t=[],i=0;i<KBEngine.app.controlledEntities.length;i++)KBEngine.app.controlledEntities[i]!=e?t.push(KBEngine.app.controlledEntities[i]):KBEngine.Event.fire("onLoseControlledEntity");KBEngine.app.controlledEntities=t,delete KBEngine.app.entities[e];for(var r=[],i=0;i<KBEngine.app.entityIDAliasIDList.length;i++)KBEngine.app.entityIDAliasIDList[i]!=e&&r.push(KBEngine.app.entityIDAliasIDList[i]);KBEngine.app.entityIDAliasIDList=r}else KBEngine.app.clearSpace(!1),n.cell=null},KBEngineApp.prototype.Client_onEntityDestroyed=function(e){INFO_MSG("KBEngineApp::Client_onEntityDestroyed: entity("+e+")!");var n=KBEngine.app.entities[e];return void 0==n?void ERROR_MSG("KBEngineApp::Client_onEntityDestroyed: entity("+e+") not found!"):(n.inWorld&&(KBEngine.app.entity_id==e&&KBEngine.app.clearSpace(!1),n.leaveWorld()),void delete KBEngine.app.entities[e])},KBEngineApp.prototype.Client_onEntityEnterSpace=function(e){var n=e.readInt32();
KBEngine.app.spaceID=e.readUint32();var t=!0;e.length()>0&&(t=e.readInt8());var i=KBEngine.app.entities[n];return void 0==i?void ERROR_MSG("KBEngineApp::Client_onEntityEnterSpace: entity("+n+") not found!"):(i.isOnGround=t,KBEngine.app.entityServerPos.x=i.position.x,KBEngine.app.entityServerPos.y=i.position.y,KBEngine.app.entityServerPos.z=i.position.z,void i.enterSpace())},KBEngineApp.prototype.Client_onEntityLeaveSpace=function(e){var n=KBEngine.app.entities[e];return void 0==n?void ERROR_MSG("KBEngineApp::Client_onEntityLeaveSpace: entity("+e+") not found!"):(KBEngine.app.clearSpace(!1),void n.leaveSpace())},KBEngineApp.prototype.Client_onKicked=function(e){ERROR_MSG("KBEngineApp::Client_onKicked: failedcode("+KBEngine.app.serverErrs[e].name+")!"),KBEngine.Event.fire("onKicked",e)},KBEngineApp.prototype.Client_onCreateAccountResult=function(e){var n=e.readUint16(),t=e.readBlob();return KBEngine.Event.fire("onCreateAccountResult",n,t),0!=n?void ERROR_MSG("KBEngineApp::Client_onCreateAccountResult: "+KBEngine.app.username+" create is failed! code="+KBEngine.app.serverErrs[n].name+"!"):void INFO_MSG("KBEngineApp::Client_onCreateAccountResult: "+KBEngine.app.username+" create is successfully!")},KBEngineApp.prototype.Client_onControlEntity=function(e,n){var t=KBEngine.app.entities[e];if(void 0==t)return void ERROR_MSG("KBEngineApp::Client_onControlEntity: entity("+e+") not found!");var i=0!=n;if(i)KBEngine.app.player().id!=t.id&&KBEngine.app.controlledEntities.push(t);else{for(var r=[],a=0;a<KBEngine.app.controlledEntities.length;a++)KBEngine.app.controlledEntities[a]!=t.id&&r.push(KBEngine.app.controlledEntities[a]);KBEngine.app.controlledEntities=r}t.isControlled=i;try{t.onControlled(i),KBEngine.Event.fire("onControlled",t,i)}catch(p){ERROR_MSG("KBEngine::Client_onControlEntity: entity id = '"+e+"', is controlled = '"+i+"', error = '"+p+"'")}},KBEngineApp.prototype.updatePlayerToServer=function(){var e=KBEngine.app.player();if(void 0!=e&&0!=e.inWorld&&0!=KBEngine.app.spaceID&&!e.isControlled){if(e.entityLastLocalPos.distance(e.position)>.001||e.entityLastLocalDir.distance(e.direction)>.001){e.entityLastLocalPos.x=e.position.x,e.entityLastLocalPos.y=e.position.y,e.entityLastLocalPos.z=e.position.z,e.entityLastLocalDir.x=e.direction.x,e.entityLastLocalDir.y=e.direction.y,e.entityLastLocalDir.z=e.direction.z;var n=new Bundle;n.newMessage(messages.Baseapp_onUpdateDataFromClient),n.writeFloat(e.position.x),n.writeFloat(e.position.y),n.writeFloat(e.position.z),n.writeFloat(e.direction.x),n.writeFloat(e.direction.y),n.writeFloat(e.direction.z),n.writeUint8(e.isOnGround),n.writeUint32(KBEngine.app.spaceID),n.send(KBEngine.app)}for(var t in KBEngine.app.controlledEntities){var i=KBEngine.app.controlledEntities[t],r=i.position,a=i.direction,p=i.entityLastLocalPos.distance(r)>.001,o=i.entityLastLocalDir.distance(a)>.001;if(p||o){i.entityLastLocalPos=r,i.entityLastLocalDir=a;var n=new Bundle;n.newMessage(messages.Baseapp_onUpdateDataFromClientForControlledEntity),n.writeInt32(i.id),n.writeFloat(r.x),n.writeFloat(r.y),n.writeFloat(r.z),n.writeFloat(a.x),n.writeFloat(a.y),n.writeFloat(a.z),n.writeUint8(i.isOnGround),n.writeUint32(KBEngine.app.spaceID),n.send(KBEngine.app)}}}},KBEngineApp.prototype.addSpaceGeometryMapping=function(e,n){INFO_MSG("KBEngineApp::addSpaceGeometryMapping: spaceID("+e+"), respath("+n+")!"),KBEngine.app.spaceID=e,KBEngine.app.spaceResPath=n,KBEngine.Event.fire("addSpaceGeometryMapping",n)},KBEngineApp.prototype.clearSpace=function(e){KBEngine.app.entityIDAliasIDList=[],KBEngine.app.spacedata={},KBEngine.app.clearEntities(e),KBEngine.app.isLoadedGeometry=!1,KBEngine.app.spaceID=0},KBEngineApp.prototype.clearEntities=function(e){if(KBEngine.app.controlledEntities=[],e){for(var n in KBEngine.app.entities)KBEngine.app.entities[n].inWorld&&KBEngine.app.entities[n].leaveWorld(),KBEngine.app.entities[n].onDestroy();KBEngine.app.entities={}}else{var t=KBEngine.app.player();for(var n in KBEngine.app.entities)n!=t.id&&(KBEngine.app.entities[n].inWorld&&KBEngine.app.entities[n].leaveWorld(),KBEngine.app.entities[n].onDestroy());KBEngine.app.entities={},KBEngine.app.entities[t.id]=t}},KBEngineApp.prototype.Client_initSpaceData=function(e){for(KBEngine.app.clearSpace(!1),KBEngine.app.spaceID=e.readInt32();e.length()>0;){var n=e.readString(),t=e.readString();KBEngine.app.Client_setSpaceData(KBEngine.app.spaceID,n,t)}INFO_MSG("KBEngineApp::Client_initSpaceData: spaceID("+KBEngine.app.spaceID+"), datas("+KBEngine.app.spacedata+")!")},KBEngineApp.prototype.Client_setSpaceData=function(e,n,t){INFO_MSG("KBEngineApp::Client_setSpaceData: spaceID("+e+"), key("+n+"), value("+t+")!"),KBEngine.app.spacedata[n]=t,"_mapping"==n&&KBEngine.app.addSpaceGeometryMapping(e,t),KBEngine.Event.fire("onSetSpaceData",e,n,t)},KBEngineApp.prototype.Client_delSpaceData=function(e,n){INFO_MSG("KBEngineApp::Client_delSpaceData: spaceID("+e+"), key("+n+")!"),delete KBEngine.app.spacedata[n],KBEngine.Event.fire("onDelSpaceData",e,n)},KBEngineApp.prototype.Client_getSpaceData=function(e,n){return KBEngine.app.spacedata[n]},KBEngineApp.prototype.Client_onUpdateBasePos=function(e,n,t){KBEngine.app.entityServerPos.x=e,KBEngine.app.entityServerPos.y=n,KBEngine.app.entityServerPos.z=t},KBEngineApp.prototype.Client_onUpdateBasePosXZ=function(e,n){KBEngine.app.entityServerPos.x=e,KBEngine.app.entityServerPos.z=n},KBEngineApp.prototype.Client_onUpdateData=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=KBEngine.app.entities[n];return void 0==t?void ERROR_MSG("KBEngineApp::Client_onUpdateData: entity("+n+") not found!"):void 0},KBEngineApp.prototype.Client_onSetEntityPosAndDir=function(e){var n=e.readInt32(),t=KBEngine.app.entities[n];return void 0==t?void ERROR_MSG("KBEngineApp::Client_onSetEntityPosAndDir: entity("+n+") not found!"):(t.position.x=e.readFloat(),t.position.y=e.readFloat(),t.position.z=e.readFloat(),t.direction.x=e.readFloat(),t.direction.y=e.readFloat(),t.direction.z=e.readFloat(),t.entityLastLocalPos.x=t.position.x,t.entityLastLocalPos.y=t.position.y,t.entityLastLocalPos.z=t.position.z,t.entityLastLocalDir.x=t.direction.x,t.entityLastLocalDir.y=t.direction.y,t.entityLastLocalDir.z=t.direction.z,t.set_direction(t.direction),void t.set_position(t.position))},KBEngineApp.prototype.Client_onUpdateData_ypr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8(),r=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,i,r,-1)},KBEngineApp.prototype.Client_onUpdateData_yp=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,i,KBEngine.KBE_FLT_MAX,-1)},KBEngineApp.prototype.Client_onUpdateData_yr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,KBEngine.KBE_FLT_MAX,i,-1)},KBEngineApp.prototype.Client_onUpdateData_pr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,i,-1)},KBEngineApp.prototype.Client_onUpdateData_y=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,-1)},KBEngineApp.prototype.Client_onUpdateData_p=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,KBEngine.KBE_FLT_MAX,-1)},KBEngineApp.prototype.Client_onUpdateData_r=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,-1)},KBEngineApp.prototype.Client_onUpdateData_xz=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,1)},KBEngineApp.prototype.Client_onUpdateData_xz_ypr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),r=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,r,a,1)},KBEngineApp.prototype.Client_onUpdateData_xz_yp=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,r,KBEngine.KBE_FLT_MAX,1)},KBEngineApp.prototype.Client_onUpdateData_xz_yr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,KBEngine.KBE_FLT_MAX,r,1)},KBEngineApp.prototype.Client_onUpdateData_xz_pr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,i,r,1)},KBEngineApp.prototype.Client_onUpdateData_xz_y=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,1)},KBEngineApp.prototype.Client_onUpdateData_xz_p=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,i,KBEngine.KBE_FLT_MAX,1)},KBEngineApp.prototype.Client_onUpdateData_xz_r=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,i,1)},KBEngineApp.prototype.Client_onUpdateData_xyz=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY();KBEngine.app._updateVolatileData(n,t[0],i,t[1],KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,0)},KBEngineApp.prototype.Client_onUpdateData_xyz_ypr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),r=e.readInt8(),a=e.readInt8(),p=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],r,a,p,0)},KBEngineApp.prototype.Client_onUpdateData_xyz_yp=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),r=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],r,a,KBEngine.KBE_FLT_MAX,0)},KBEngineApp.prototype.Client_onUpdateData_xyz_yr=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),r=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],r,KBEngine.KBE_FLT_MAX,a,0)},KBEngineApp.prototype.Client_onUpdateData_xyz_pr=function(e){KBEngine.app.getViewEntityIDFromStream(e),e.readPackXZ(),e.readPackY(),e.readInt8(),e.readInt8();ERROR_MSG("调用错误方法，无法找到x,z")},KBEngineApp.prototype.Client_onUpdateData_xyz_y=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],r,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,0)},KBEngineApp.prototype.Client_onUpdateData_xyz_p=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],KBEngine.KBE_FLT_MAX,r,KBEngine.KBE_FLT_MAX,0)},KBEngineApp.prototype.Client_onUpdateData_xyz_r=function(e){var n=KBEngine.app.getViewEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),r=e.readInt8();e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],r,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,0)},KBEngineApp.prototype._updateVolatileData=function(e,n,t,i,r,a,p,o){var s=KBEngine.app.entities[e];if(void 0==s)return void ERROR_MSG("KBEngineApp::_updateVolatileData: entity("+e+") not found!");o>=0&&(s.isOnGround=o>0);var E=!1;p!=KBEngine.KBE_FLT_MAX&&(E=!0,s.direction.x=int82angle(p,!1)),a!=KBEngine.KBE_FLT_MAX&&(E=!0,s.direction.y=int82angle(a,!1)),r!=KBEngine.KBE_FLT_MAX&&(E=!0,s.direction.z=int82angle(r,!1));var g=!1;1==E&&(KBEngine.Event.fire("set_direction",s),g=!0);var l=!1;(n!=KBEngine.KBE_FLT_MAX||t!=KBEngine.KBE_FLT_MAX||i!=KBEngine.KBE_FLT_MAX)&&(l=!0),n==KBEngine.KBE_FLT_MAX&&(n=0),t==KBEngine.KBE_FLT_MAX&&(t=0),i==KBEngine.KBE_FLT_MAX&&(i=0),l&&(s.position.x=n+KBEngine.app.entityServerPos.x,s.position.y=t+KBEngine.app.entityServerPos.y,s.position.z=i+KBEngine.app.entityServerPos.z,g=!0,KBEngine.Event.fire("updatePosition",s)),g&&s.onUpdateVolatileData()},KBEngineApp.prototype.Client_onStreamDataStarted=function(e,n,t){KBEngine.Event.fire("onStreamDataStarted",e,n,t)},KBEngineApp.prototype.Client_onStreamDataRecv=function(e){var n=e.readUint16(),t=e.readBlob();KBEngine.Event.fire("onStreamDataRecv",n,t)},KBEngineApp.prototype.Client_onStreamDataCompleted=function(e){KBEngine.Event.fire("onStreamDataCompleted",e)},KBEngineApp.prototype.Client_onReqAccountResetPasswordCB=function(e){return 0!=e?void ERROR_MSG("KBEngineApp::Client_onReqAccountResetPasswordCB: "+KBEngine.app.username+" is failed! code="+KBEngine.app.serverErrs[e].name+"!"):void INFO_MSG("KBEngineApp::Client_onReqAccountResetPasswordCB: "+KBEngine.app.username+" is successfully!")},KBEngineApp.prototype.Client_onReqAccountBindEmailCB=function(e){return 0!=e?void ERROR_MSG("KBEngineApp::Client_onReqAccountBindEmailCB: "+KBEngine.app.username+" is failed! code="+KBEngine.app.serverErrs[e].name+"!"):void INFO_MSG("KBEngineApp::Client_onReqAccountBindEmailCB: "+KBEngine.app.username+" is successfully!")},KBEngineApp.prototype.Client_onReqAccountNewPasswordCB=function(e){return 0!=e?void ERROR_MSG("KBEngineApp::Client_onReqAccountNewPasswordCB: "+KBEngine.app.username+" is failed! code="+KBEngine.app.serverErrs[e].name+"!"):void INFO_MSG("KBEngineApp::Client_onReqAccountNewPasswordCB: "+KBEngine.app.username+" is successfully!")},KBEngineApp}();KBEngine.KBEngineApp=KBEngineApp,__reflect(KBEngineApp.prototype,"KBEngine.KBEngineApp");var ServerErr=function(){function e(){this.name="",this.descr="",this.id=0}return e}();KBEngine.ServerErr=ServerErr,__reflect(ServerErr.prototype,"KBEngine.ServerErr");var idInterval;KBEngine.create=create,KBEngine.destroy=destroy}(KBEngine||(KBEngine={}));